# coding: utf-8


import operator
import os

import plotly.graph_objs as go
from cpe import CPE
from lxml import etree
from plotly.offline import init_notebook_mode, iplot

from CVE import Stats

init_notebook_mode()
# tree = ET.iterparse(open('test.xml'))

NSMAP = {
    None: 'http://scap.nist.gov/schema/feed/vulnerability/2.0',
    'vuln': 'http://scap.nist.gov/schema/vulnerability/0.4',
}

# These vendors were chosen because they had the most cves reported in 2015
intrest = ['apple', 'cisco', 'oracle', 'adobe']
vendorList = []


def prefixed(ns_prefix, rest):
    return '{%s}%s' % (NSMAP[ns_prefix], rest)


def getscore(cvss):
    return float(cvss[0].text)


def getinfo(filename):
    if os.path.exists(filename + '.bin'):
        print(filename, "exists -- taking in")
        with open(filename + '.bin', 'rb') as reader:
            return eval(reader.read())
    print(filename, "binary does not exist, parsing")
    f = open(filename)
    tree = etree.parse(f)
    f.close()
    vulns = []
    entry_nodes = tree.getroot()
    print(len(entry_nodes))
    for entry in entry_nodes:
        # print("found entry")
        thisvuln = {'id': entry.find(prefixed('vuln', 'cve-id')).text}
        # print(thisvuln)
        vulnsoftware = entry.find(prefixed('vuln', 'vulnerable-software-list'))
        #
        if vulnsoftware is not None:
            for vv in vulnsoftware:
                product = vv.findall(prefixed('vuln', 'product'))
                for p in product:

                    print(".")
                    product = p.find(prefixed('vuln', 'product'))

                    try:
                        print(product.text)
                        mycpe = CPE(product.text)
                    except NotImplementedError as e:
                        print(e)

                    else:
                        thisvuln['part'] = mycpe.get_part()[0]
                        thisvuln['vendor'] = mycpe.get_vendor()[0]
                        if thisvuln['vendor'] not in vendorList:
                            print("Found a new vendor", thisvuln['vendor'])
                            vendorList.append(thisvuln['vendor'])
                        if 'linux' in thisvuln['vendor']:
                            thisvuln['vendor'] = 'linux'
                        thisvuln['product'] = mycpe.get_product()[0]
                        if 'linux' in thisvuln['product']:
                            thisvuln['vendor'] = 'linux'
                        thisvuln['version'] = mycpe.get_version()[0]
                        thisvuln['update'] = mycpe.get_update()[0]
                        thisvuln['edition'] = mycpe.get_edition()[0]
                        thisvuln['language'] = mycpe.get_language()[0]

        cvss = entry.find(prefixed('vuln', 'cvss'))
        # print(cvss)
        if cvss is not None:
            thisvuln['score'] = cvss.getchildren()[0].getchildren()[0].text
            thisvuln['accessVector'] = cvss.getchildren()[0].getchildren()[1].text
            thisvuln['accessComplexity'] = cvss.getchildren()[0].getchildren()[2].text
            thisvuln['auth'] = cvss.getchildren()[0].getchildren()[3].text
            thisvuln['impactConf'] = cvss.getchildren()[0].getchildren()[4].text
            thisvuln['impactInt'] = cvss.getchildren()[0].getchildren()[5].text
            thisvuln['impactAvail'] = cvss.getchildren()[0].getchildren()[6].text

        summery = entry.find(prefixed('vuln', 'summary'))
        thisvuln['summery'] = summery.text

        vulns.append(thisvuln)

    return vulns


def make_pie(data: list) -> None:
    vendoraverage = {}
    skipping = 0
    for cve in data:
        try:
            vendor = cve['vendor']
            score = cve['score']
            if vendor in vendoraverage:
                vendoraverage[vendor].addscore(score)
            else:
                vendoraverage[vendor] = Stats(vendor)
                vendoraverage[vendor].addscore(score)
        except KeyError:
            # Expected to have KeyErrors
            skipping += 1

    for vendor in vendoraverage:
        if vendor in intrest:
            tmp = vendoraverage[vendor]
            if tmp is not None:
                pie = tmp.getpiegraphchunks()
                fig = {
                    'data': [{'labels': pie[0],
                              'marker': {'colors': ['#87FC70',
                                                    '#FFDB4C',
                                                    '#FF5E3A']},
                              'values': pie[1],
                              'textposition': 'outside',
                              'textinfo': 'value+percent',
                              'type': 'pie'}],
                    'layout': {'title': 'Data for: ' + vendor.title() + ' 2015 CVE', 'width': 500, 'height': 500}
                }
                iplot(fig)


def get_top_five(data):
    vendors = {}
    for i in data:
        try:
            vendors[i['vendor']] += 1
        except KeyError:
            vendors[i['vendor']] = 1

    sorted_x = sorted(vendors.items(), key=operator.itemgetter(1), reverse=True)

    return sorted_x[0:5]


def get_top_five_scores(data):
    vendoraverage = {}
    for cve in data:
        try:
            vendor = cve['vendor']
            score = cve['score']
            if vendor in vendoraverage:
                vendoraverage[vendor].addscore(score)
            else:
                vendoraverage[vendor] = Stats(vendor)
                vendoraverage[vendor].addscore(score)
        except KeyError:
            pass

    topfive = get_top_five(data)

    vendorscores = {}
    for i in topfive:
        vendorscores[i[0]] = vendoraverage[i[0]].getaverage()

    print(vendorscores)
    vendorscores = sorted(vendorscores.items(), key=operator.itemgetter(1), reverse=True)
    print(vendorscores)
    for k in vendorscores:
        print("-", k)


def trend_over_years():
    filename = "data/nvdcve-2.0-"
    fileext = "xml"
    vendorsyear = {}

    for year in range(2002, 2016):
        cvefile = filename + str(year) + "." + fileext
        data = getinfo(cvefile)
        for cve in data:
            print("Working on a new CVE")
            try:
                vendor = cve['vendor']
                score = cve['score']
                if vendor not in intrest:
                    continue
                if vendor not in vendorsyear.keys():
                    vendorsyear[vendor] = {}
                if year not in vendorsyear[vendor]:
                    vendorsyear[vendor][year] = Stats(vendor)
                vendorsyear[vendor][year].addscore(score)
            except KeyError:
                #                 print cve, "does not have a vendor associated with it"
                print("KeyError")
                pass

    datatograph = []
    ydataset = {}
    xdataset = range(2002, 2016)
    for k, v in vendorsyear.items():
        print(k, ":")
        ydataset[k] = []
        for m, n in v.items():
            #             print m,n.getaverage()
            ydataset[k].append(n.getaverage())

    print(ydataset)

    for company in ydataset:
        trace = go.Scatter(x=xdataset, y=ydataset[company], mode='line', name=company)
        datatograph.append(trace)

    iplot(datatograph)


def graph_by_type(data):
    def count(string: str, alist: list, should_print: bool = False) -> int:
        num = 0
        if any(ext.lower() in string.lower() for ext in alist):
            if should_print:
                print("Found: ", string)
            num += 1
        return num

    xss = ["cross site scripting", "xss", "cross-site-scripting"]
    xsscount = 0

    injection = ["sql injection", "injection", "sqli"]
    injectioncount = 0

    csrf = ["cross site request forgery", "csrf", "cross-site-request-forgery"]
    csrfcount = 0

    buffer_overflow = ["bfo", "buffer overflow", "overflow"]
    buffer_overflow_count = 0

    deserialization = ["deserialization attack", "deserialization", "serialization"]
    deserialization_count = 0

    for vulns in data:
        summery = vulns['summery']
        xsscount += count(summery, xss)
        injectioncount += count(summery, injection)
        csrfcount += count(summery, csrf)
        buffer_overflow_count += count(summery, buffer_overflow)
        deserialization_count += count(summery, deserialization)

    iplot({
        'data': [{'labels': ["XSS", "CSRF", "Injection", "Buffer Overflow", "Deserialization"],
                  'values': [xsscount, csrfcount, injectioncount, buffer_overflow_count, deserialization_count],
                  'type': 'pie'}],
        'layout': {'title': 'Attack type distribution'}
    })
